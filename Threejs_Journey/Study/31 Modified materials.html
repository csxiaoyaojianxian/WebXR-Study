<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link type="text/css" rel="stylesheet" href="./public.css" />
</head>

<section class="text js-text">
    <h2>Introduction</h2>
<p>Until now, we were creating brand new shader materials. But what if we only want to modify one of the Three.js built-in materials? Maybe we are happy with the result of the <a target="_blank" href="https://threejs.org/docs/#api/en/materials/MeshStandardMaterial">MeshStandardMaterial</a>, but we want to add vertex animations to it. If we were to rewrite the whole <a target="_blank" href="https://threejs.org/docs/#api/en/materials/MeshStandardMaterial">MeshStandardMaterial</a>, it would take too much time to handle the lights, the environment maps, physically based rendering, all the types of textures, etc.</p>
<p>Instead, we will start from the <a target="_blank" href="https://threejs.org/docs/#api/en/materials/MeshStandardMaterial">MeshStandardMaterial</a> and try to integrate our code in its shaders.</p>
<p>There are two ways of doing it:</p>
<ul>
<li>By using a Three.js hook triggered before the shader is compiled that let us play with the shaders and inject our code.</li>
<li>By recreating the material as a brand new one, but following what is done in Three.js code and then using the same parameters, plus the ones that we want to add.</li>
</ul>
<p>While the second option is perfectly acceptable, we would need to spend a lot of time in the Three.js source code to understand how to set everything right.</p>
<p>Instead, we will use the first technique. We still will spend some time in the Three.js code, but it will be much easier.</p>
<p>In this lesson, we will make the model vertices twist in a funny way but with all the base features of the material still working like shadows, texture, normal map, etc.</p>
<h2>Setup</h2>
<p>We will use the same setup as the <strong>Realistic Model Render</strong> lesson but with the famous <strong>Lee Perry-Smith</strong> head model. It's just a popular model with only one mesh and realistic textures that should go well with our twist animation.</p>
<p class="is-image"><span class="image-inner"><img data-src="./assets/lessons/31/step-01.png" src="./assets/lessons/31/step-01.png" width="1792" height="1120" alt="./assets/lessons/31/step-01.png" class="is-loaded"></span></p>
<p>Both the loading and base material setup is already done. A <a target="_blank" href="https://threejs.org/docs/#api/en/materials/MeshStandardMaterial">MeshStandardMaterial</a> with a <code spellcheck="false">map</code> and a <code spellcheck="false">normalMap</code> are created before loading the model. This material is then used on the only <a target="_blank" href="https://threejs.org/docs/#api/en/objects/Mesh">Mesh</a> of the model. This <a target="_blank" href="https://threejs.org/docs/#api/en/objects/Mesh">Mesh</a> is finally added to the scene.</p>
<p>Most of the following code will concern the material.</p>
<h2>Hooking the material</h2>
<p>We have our <a target="_blank" href="https://threejs.org/docs/#api/en/materials/MeshStandardMaterial">MeshStandardMaterial</a>, but we want to modify its shader.</p>
<p>To modify a material, we first need access to its original shaders. To do that, we can use the <code spellcheck="false">onBeforeCompile</code> property on the material.</p>
<p>If we assign a function to it, this function will be called with the shader options as the first parameter right before being compiled:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-javascript"><code spellcheck="false" class=" language-javascript">material<span class="token punctuation">.</span><span class="token function-variable function">onBeforeCompile</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">shader</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>shader<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>JavaScript</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p>We now have access to the <code spellcheck="false">vertexShader</code>, the <code spellcheck="false">fragmentShader</code>, and the <code spellcheck="false">uniforms</code> and we can modify these and see the result.</p>
<h2>Adding content to the vertex shader</h2>
<p>If you look at the <code spellcheck="false">vertexShader</code>, there isn't much code. Three.js uses its own system to include shader parts to prevent repeating the same code between the different materials. Each <code spellcheck="false">#include ...</code> will inject a code located in specific folder of the Three.js dependency.</p>
<p>That is, in a way, suitable for us because we can replace those parts with a simple native JavaScript <a target="_blank" href="https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String/replace">replace(...)</a>.</p>
<p>The problem is that we don't know which part is doing what and which one to replace. To understand the code, we need to dive into the <code spellcheck="false">three</code> dependency.</p>
<p>Go to the <code spellcheck="false">/node_modules/three/src/renderers/shaders/</code> folder. That is where you'll find most of the Three.js shader codes.</p>
<p>All the included parts are called chunks, and you can find them in the <code spellcheck="false">ShaderChunk/</code> folder.</p>
<p>If we look at the different chunks, it seems that <code spellcheck="false">begin_vertex</code> is handling the position first by creating a variable named <code spellcheck="false">transformed</code>.</p>
<p>Let's build our code on that. First, we need to replace this part of the code. Because the chunk is named <code spellcheck="false">begin_vertex</code>, we need to replace <code spellcheck="false">#include &lt;begin_vertex&gt;</code>:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-javascript"><code spellcheck="false" class=" language-javascript">material<span class="token punctuation">.</span><span class="token function-variable function">onBeforeCompile</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">shader</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
shader<span class="token punctuation">.</span>vertexShader <span class="token operator">=</span> shader<span class="token punctuation">.</span>vertexShader<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">'#include &lt;begin_vertex&gt;'</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>JavaScript</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p>That should break the material because we are replacing the previous code with nothing. Our code will be a few lines long, so we are going to use back quotes.</p>
<p>Put the <code spellcheck="false">include ...</code> back, to begin with, and not break anything:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-javascript"><code spellcheck="false" class=" language-javascript">material<span class="token punctuation">.</span><span class="token function-variable function">onBeforeCompile</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">shader</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
shader<span class="token punctuation">.</span>vertexShader <span class="token operator">=</span> shader<span class="token punctuation">.</span>vertexShader<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
<span class="token string">'#include &lt;begin_vertex&gt;'</span><span class="token punctuation">,</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
#include &lt;begin_vertex&gt;
</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>JavaScript</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p class="is-image"><span class="image-inner"><img data-src="./assets/lessons/31/step-02.png" src="./assets/lessons/31/step-02.png" width="1792" height="1120" alt="./assets/lessons/31/step-02.png" class="is-loaded"></span></p>
<p>This code is useless because we are replacing something with the same thing, but now we can add our own code after the <code spellcheck="false">include</code>.</p>
<p>As an example, let's move our head on the <code spellcheck="false">y</code> axis. We saw in the <code spellcheck="false">/node_modules/three/src/renderers/shaders/ShaderChunks/begin_vertex.glsl.js</code> file that a <code spellcheck="false">transformed</code> variable is created and should contain the position of the vertex. It's <code spellcheck="false">y</code> property to move all the vertices:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-javascript"><code spellcheck="false" class=" language-javascript">shader<span class="token punctuation">.</span>vertexShader <span class="token operator">=</span> shader<span class="token punctuation">.</span>vertexShader<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
<span class="token string">'#include &lt;begin_vertex&gt;'</span><span class="token punctuation">,</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
#include &lt;begin_vertex&gt;

transformed.y += 3.0;
</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">)</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>JavaScript</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p class="is-image"><span class="image-inner"><img data-src="./assets/lessons/31/step-03.png" src="./assets/lessons/31/step-03.png" width="1792" height="1120" alt="./assets/lessons/31/step-03.png" class="is-loaded"></span></p>
<p>As you can see, it's working, but the shadow seems bugged. We will fix that later.</p>
<p>Remove the <code spellcheck="false">transformed.y += 3.0;</code>.</p>
<h2>Twisting</h2>
<p>Let's do the twist... on our vertices. There are multiple mathematics ways of doing the twist effect and this time, we are going to create a matrix.</p>
<p>Only the GLSL part will be present in the following code.</p>
<p>First, we will try to rotate all the vertices at the same angle. Then we will offset that angle depending on the elevation of the vertex and animate it.</p>
<p>Create an <code spellcheck="false">angle</code> variable with any value:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-glsl"><code spellcheck="false" class=" language-glsl"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;begin_vertex&gt;</span></span>

<span class="token keyword">float</span> angle <span class="token operator">=</span> <span class="token number">0.3</span><span class="token punctuation">;</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>GLSL</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p>Even if we aren't moving the vertices yet, you can still refresh to see if an error occurred.</p>
<p>If you remember, matrices are like a pipe where you send data —like a vector. The pipe will apply a transformation on that vector and output the result. We can create a matrix that scales the vector, one that rotates, one that moves, and we can even combine them. Those matrices can handle 2D transformations, 3D transformations, and even more.</p>
<p>In our case, we want to do a 2D transformations. Indeed, our vertices have 3D coordinates, but to do the twist animation, we are just rotating the vertices on the <code spellcheck="false">x</code> and <code spellcheck="false">z</code> axes, not up and down on the <code spellcheck="false">y</code> axis.</p>
<p>To create the 2D rotation matrix, we won't go into mathematic details. Instead, we'll use this function that returns a 2 dimensions matrix (<code spellcheck="false">mat2</code>):</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-glsl"><code spellcheck="false" class=" language-glsl"><span class="token keyword">mat2</span> <span class="token function">get2dRotateMatrix</span><span class="token punctuation">(</span><span class="token keyword">float</span> _angle<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token keyword">return</span> <span class="token keyword">mat2</span><span class="token punctuation">(</span><span class="token function">cos</span><span class="token punctuation">(</span>_angle<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span> <span class="token function">sin</span><span class="token punctuation">(</span>_angle<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sin</span><span class="token punctuation">(</span>_angle<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cos</span><span class="token punctuation">(</span>_angle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>GLSL</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p>If you want to know more about it, you can find details on The Book of Shaders: <a target="_blank" href="https://thebookofshaders.com/08/">https://thebookofshaders.com/08/</a></p>
<p>But where should we add this function exactly? If it were our own shader, we would have put it before the <code spellcheck="false">main</code> function, and this is exactly what we are going to do. One chunk outside of the <code spellcheck="false">main</code> function is <code spellcheck="false">common</code>. This chunk has the advantage of being present on all shaders. Let's replace this part as we did with the <code spellcheck="false">begin_vertex</code> chunk:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-javascript"><code spellcheck="false" class=" language-javascript">material<span class="token punctuation">.</span><span class="token function-variable function">onBeforeCompile</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">shader</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
shader<span class="token punctuation">.</span>vertexShader <span class="token operator">=</span> shader<span class="token punctuation">.</span>vertexShader<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
<span class="token string">'#include &lt;common&gt;'</span><span class="token punctuation">,</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
#include &lt;common&gt;
</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">)</span>

<span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>JavaScript</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p>We can now add our <code spellcheck="false">get2dRotateMatrix</code>:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-javascript"><code spellcheck="false" class=" language-javascript">material<span class="token punctuation">.</span><span class="token function-variable function">onBeforeCompile</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">shader</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
shader<span class="token punctuation">.</span>vertexShader <span class="token operator">=</span> shader<span class="token punctuation">.</span>vertexShader<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
<span class="token string">'#include &lt;common&gt;'</span><span class="token punctuation">,</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
#include &lt;common&gt;

mat2 get2dRotateMatrix(float _angle)
{
    return mat2(cos(_angle), - sin(_angle), sin(_angle), cos(_angle));
}
</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">)</span>

<span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>JavaScript</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p>Nothing changed, but we now have access to the <code spellcheck="false">get2dRotateMatrix</code> anywhere in the shader, as in the <code spellcheck="false">begin_vertex</code> chunk. That is because all the chunks are merged as if it was only one code.</p>
<p>Create the <code spellcheck="false">rotateMatrix</code> variable using the <code spellcheck="false">get2dRotateMatrix</code> function:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-glsl"><code spellcheck="false" class=" language-glsl"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;begin_vertex&gt;</span></span>

<span class="token keyword">float</span> angle <span class="token operator">=</span> <span class="token number">0.3</span><span class="token punctuation">;</span>
<span class="token keyword">mat2</span> rotateMatrix <span class="token operator">=</span> <span class="token function">get2dRotateMatrix</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>GLSL</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p>We now have access to a matrix named <code spellcheck="false">rotateMatrix</code> that should rotate a <code spellcheck="false">vec2</code>. Let's apply this matrix to the <code spellcheck="false">x</code> and <code spellcheck="false">z</code> properties together:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-glsl"><code spellcheck="false" class=" language-glsl"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;begin_vertex&gt;</span></span>

<span class="token keyword">float</span> angle <span class="token operator">=</span> <span class="token number">0.3</span><span class="token punctuation">;</span>
<span class="token keyword">mat2</span> rotateMatrix <span class="token operator">=</span> <span class="token function">get2dRotateMatrix</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>

transformed<span class="token punctuation">.</span>xz <span class="token operator">=</span> rotateMatrix <span class="token operator">*</span> transformed<span class="token punctuation">.</span>xz<span class="token punctuation">;</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>GLSL</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p class="is-image"><span class="image-inner"><img data-src="./assets/lessons/31/step-04.png" src="./assets/lessons/31/step-04.png" width="1792" height="1120" alt="./assets/lessons/31/step-04.png" class="is-loaded"></span></p>
<p>The head should have rotate. Again, don't mind the shadows; we will handle that later.</p>
<p>We almost have our twist rotation. We only need to vary the <code spellcheck="false">angle</code> according to the elevation:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-glsl"><code spellcheck="false" class=" language-glsl"><span class="token keyword">float</span> angle <span class="token operator">=</span> position<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token number">0.9</span><span class="token punctuation">;</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>GLSL</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p class="is-image"><span class="image-inner"><img data-src="./assets/lessons/31/step-05.png" src="./assets/lessons/31/step-05.png" width="1792" height="1120" alt="./assets/lessons/31/step-05.png" class="is-loaded"></span></p>
<p>Poor head. It's time to animate the angle.</p>
<h2>Animating</h2>
<p>We will use the same technique as before, and send a <code spellcheck="false">uTime</code> uniform to our shader. We already have access to the uniforms with <code spellcheck="false">shader.uniforms</code>. Let's update it the same way we update a <a target="_blank" href="https://threejs.org/docs/#api/en/materials/ShaderMaterial">ShaderMaterial</a>:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-javascript"><code spellcheck="false" class=" language-javascript">material<span class="token punctuation">.</span><span class="token function-variable function">onBeforeCompile</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">shader</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
shader<span class="token punctuation">.</span>uniforms<span class="token punctuation">.</span>uTime <span class="token operator">=</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span>

<span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>JavaScript</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p>We can now retrieve our <code spellcheck="false">uTime</code> uniform in the <code spellcheck="false">common</code> chunk:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-glsl"><code spellcheck="false" class=" language-glsl"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;common&gt;</span></span>

<span class="token keyword">uniform</span> <span class="token keyword">float</span> uTime<span class="token punctuation">;</span>

<span class="token keyword">mat2</span> <span class="token function">get2dRotateMatrix</span><span class="token punctuation">(</span><span class="token keyword">float</span> _angle<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token keyword">return</span> <span class="token keyword">mat2</span><span class="token punctuation">(</span><span class="token function">cos</span><span class="token punctuation">(</span>_angle<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span> <span class="token function">sin</span><span class="token punctuation">(</span>_angle<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">sin</span><span class="token punctuation">(</span>_angle<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">cos</span><span class="token punctuation">(</span>_angle<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>GLSL</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p>And use it in the <code spellcheck="false">begin_vertex</code> chunk:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-glsl"><code spellcheck="false" class=" language-glsl"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;begin_vertex&gt;</span></span>

<span class="token keyword">float</span> angle <span class="token operator">=</span> <span class="token punctuation">(</span>position<span class="token punctuation">.</span>y <span class="token operator">+</span> uTime<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.9</span><span class="token punctuation">;</span>
<span class="token keyword">mat2</span> rotateMatrix <span class="token operator">=</span> <span class="token function">get2dRotateMatrix</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>

transformed<span class="token punctuation">.</span>xz <span class="token operator">=</span> rotateMatrix <span class="token operator">*</span> transformed<span class="token punctuation">.</span>xz<span class="token punctuation">;</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>GLSL</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p>You should get the same result because we aren't animating the <code spellcheck="false">uTime</code> value. Unluckily, we have a JavaScript problem. We have no apparent way to access the uniform in the <code spellcheck="false">tick</code> function. Unlike a <a target="_blank" href="https://threejs.org/docs/#api/en/materials/ShaderMaterial">ShaderMaterial</a>, we cannot just access the <code spellcheck="false">uniforms</code> of <code spellcheck="false">material</code>, and this is due to the Three.js structure.</p>
<p>There are many ways of fixing that. All we need is access to those uniforms. Let's create a <code spellcheck="false">customUniforms</code> object before the material and add our <code spellcheck="false">uTime</code> inside:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-glsl"><code spellcheck="false" class=" language-glsl"><span class="token keyword">const</span> customUniforms <span class="token operator">=</span> <span class="token punctuation">{</span>
uTime<span class="token operator">:</span> <span class="token punctuation">{</span> value<span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>GLSL</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p>Then, we use that object in the <code spellcheck="false">onBeforeCompile</code> function:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-javascript"><code spellcheck="false" class=" language-javascript">material<span class="token punctuation">.</span><span class="token function-variable function">onBeforeCompile</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">shader</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
shader<span class="token punctuation">.</span>uniforms<span class="token punctuation">.</span>uTime <span class="token operator">=</span> customUniforms<span class="token punctuation">.</span>uTime

<span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>JavaScript</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p>And because our <code spellcheck="false">customUniforms</code> has been declared outside of any scope, we can simply update it in the <code spellcheck="false">tick</code> function with the <code spellcheck="false">elapsedTime</code> variable:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-javascript"><code spellcheck="false" class=" language-javascript"><span class="token keyword">const</span> clock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Clock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">tick</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
<span class="token keyword">const</span> elapsedTime <span class="token operator">=</span> clock<span class="token punctuation">.</span><span class="token function">getElapsedTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Update material</span>
customUniforms<span class="token punctuation">.</span>uTime<span class="token punctuation">.</span>value <span class="token operator">=</span> elapsedTime

<span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>JavaScript</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p>
        </p><div class="js-video video">
            <video class="js-element element" width="1792" height="1120" controls="" src="./assets/lessons/31/step-06.mp4"></video>
            <div class="js-overlay overlay"></div>
            <div class="logo">
                <svg version="1.1" id="Calque_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 58.5 66.6" style="enable-background:new 0 0 58.5 66.6;" xml:space="preserve">
                    <path class="face-1" d="M23.1,55.7l16.1-9.3c0,0,0,0,0,0c1.1-0.7,1.8-1.9,1.8-3.1l0.1-19.1L23.1,34.4V55.7z"></path>
                    <path class="face-2" d="M21.3,10L2.9,20.5l18,10.2l18.4-10.5c0,0,0,0-0.1,0l-17.4-10C21.7,10.1,21.5,10.1,21.3,10z"></path>
                    <path class="face-3" d="M1.8,46.7L18,56.6c0,0,0,0,0,0c0.3,0.2,0.5,0.3,0.8,0.3V34.5L0,23.8v19.7C0,44.9,0.7,46.1,1.8,46.7z"></path>
                    <path class="triangle-1" d="M56.8,30.4l-11.4-6.6l-0.1,19.2l11.5-6.7c1-0.6,1.7-1.7,1.7-2.9C58.5,32.1,57.9,31,56.8,30.4z"></path>
                    <path class="triangle-2" d="M0,50.7v12.6c0,1.2,0.6,2.3,1.7,2.9c0.5,0.3,1.1,0.5,1.7,0.5c0.6,0,1.2-0.2,1.7-0.5l10.4-6L0,50.7z"></path>
                    <path class="triangle-3" d="M16.4,7L5.1,0.5c-1-0.6-2.3-0.6-3.4,0C0.6,1.1,0,2.2,0,3.4v13.2L16.4,7z"></path>
                </svg>
            </div>
        </div>
    <p></p>
<p>Now, the head is rotating.</p>
<p>Let's fix the shadows.</p>
<h2>Fixing the shadow</h2>
<p>As we saw in previous lessons, when using shadows, Three.js makes renders for the scene from the light point of view. Those renders result in pictures of what is in the shadow or the light. When those renders occur, all the materials are replaced by another set of materials dedicated to that specific render. The problem is that this kind of material doesn't twist because it has nothing to do with our modified <a target="_blank" href="https://threejs.org/docs/#api/en/materials/MeshStandardMaterial">MeshStandardMaterial</a>.</p>
<p>We can see that if we add a plane right behind the head:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-javascript"><code spellcheck="false" class=" language-javascript"><span class="token comment">/**
* Plane
*/</span>
<span class="token keyword">const</span> plane <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Mesh</span><span class="token punctuation">(</span>
<span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>PlaneGeometry</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>MeshStandardMaterial</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span>
plane<span class="token punctuation">.</span>rotation<span class="token punctuation">.</span>y <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token constant">PI</span>
plane<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token operator">-</span> <span class="token number">5</span>
plane<span class="token punctuation">.</span>position<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">5</span>
scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>plane<span class="token punctuation">)</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>JavaScript</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p>
        </p><div class="js-video video">
            <video class="js-element element" width="1792" height="1120" controls="" src="./assets/lessons/31/step-07.mp4"></video>
            <div class="js-overlay overlay"></div>
            <div class="logo">
                <svg version="1.1" id="Calque_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 58.5 66.6" style="enable-background:new 0 0 58.5 66.6;" xml:space="preserve">
                    <path class="face-1" d="M23.1,55.7l16.1-9.3c0,0,0,0,0,0c1.1-0.7,1.8-1.9,1.8-3.1l0.1-19.1L23.1,34.4V55.7z"></path>
                    <path class="face-2" d="M21.3,10L2.9,20.5l18,10.2l18.4-10.5c0,0,0,0-0.1,0l-17.4-10C21.7,10.1,21.5,10.1,21.3,10z"></path>
                    <path class="face-3" d="M1.8,46.7L18,56.6c0,0,0,0,0,0c0.3,0.2,0.5,0.3,0.8,0.3V34.5L0,23.8v19.7C0,44.9,0.7,46.1,1.8,46.7z"></path>
                    <path class="triangle-1" d="M56.8,30.4l-11.4-6.6l-0.1,19.2l11.5-6.7c1-0.6,1.7-1.7,1.7-2.9C58.5,32.1,57.9,31,56.8,30.4z"></path>
                    <path class="triangle-2" d="M0,50.7v12.6c0,1.2,0.6,2.3,1.7,2.9c0.5,0.3,1.1,0.5,1.7,0.5c0.6,0,1.2-0.2,1.7-0.5l10.4-6L0,50.7z"></path>
                    <path class="triangle-3" d="M16.4,7L5.1,0.5c-1-0.6-2.3-0.6-3.4,0C0.6,1.1,0,2.2,0,3.4v13.2L16.4,7z"></path>
                </svg>
            </div>
        </div>
    <p></p>
<p>We need to find a way to twist that material too.</p>
<p>The material used for the shadows is a <a target="_blank" href="https://threejs.org/docs/#api/en/materials/MeshDepthMaterial">MeshDepthMaterial</a> and we cannot access that material easily, but we can override it with the property <code spellcheck="false">customDepthMaterial</code> on the mesh in order to tell Three.js to use a custom material.</p>
<p>First, let's create a this custom material. We are going to use a <a target="_blank" href="https://threejs.org/docs/#api/en/materials/MeshDepthMaterial">MeshDepthMaterial</a> because this is exactly what Three.js is using during those renders. We will call it <code spellcheck="false">depthMaterial</code> and add <code spellcheck="false">THREE.RGBADepthPacking</code> to its <code spellcheck="false">depthPacking</code> property:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-javascript"><code spellcheck="false" class=" language-javascript"><span class="token keyword">const</span> depthMaterial <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>MeshDepthMaterial</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
depthPacking<span class="token operator">:</span> <span class="token constant">THREE</span><span class="token punctuation">.</span>RGBADepthPacking
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>JavaScript</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p>We won't explain what the <code spellcheck="false">depthPacking</code> is in detail here, but it's just a better way of storing the depth by using the <code spellcheck="false">r</code>, <code spellcheck="false">g</code>, <code spellcheck="false">b</code>, and <code spellcheck="false">a</code> separately for better precision and Three.js needs it.</p>
<p>To apply our custom depth material, when our model is loaded, we change the <code spellcheck="false">customDepthMaterial</code> property with our own <code spellcheck="false">depthMaterial</code>:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-javascript"><code spellcheck="false" class=" language-javascript">gltfLoader<span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span>
<span class="token string">'/models/LeePerrySmith/LeePerrySmith.glb'</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span><span class="token parameter">gltf</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
<span class="token comment">// ...</span>

mesh<span class="token punctuation">.</span>material <span class="token operator">=</span> material <span class="token comment">// Update the material</span>
mesh<span class="token punctuation">.</span>customDepthMaterial <span class="token operator">=</span> depthMaterial <span class="token comment">// Update the depth material</span>

<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
<span class="token punctuation">)</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>JavaScript</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p>Here, we did it on the only mesh in the model but if we had a more complex model with multiple meshes, we would have to traverse it and update all the materials.</p>
<p>We can now apply all the changes to the shader we've made before but for the <code spellcheck="false">depthMaterial</code>.</p>
<p>Copy and paste the <code spellcheck="false">onBeforeCompile</code> part:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-javascript"><code spellcheck="false" class=" language-javascript">depthMaterial<span class="token punctuation">.</span><span class="token function-variable function">onBeforeCompile</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">shader</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
shader<span class="token punctuation">.</span>uniforms<span class="token punctuation">.</span>uTime <span class="token operator">=</span> customUniforms<span class="token punctuation">.</span>uTime
shader<span class="token punctuation">.</span>vertexShader <span class="token operator">=</span> shader<span class="token punctuation">.</span>vertexShader<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
<span class="token string">'#include &lt;common&gt;'</span><span class="token punctuation">,</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
#include &lt;common&gt;

uniform float uTime;

mat2 get2dRotateMatrix(float _angle)
{
    return mat2(cos(_angle), - sin(_angle), sin(_angle), cos(_angle));
}
</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">)</span>
shader<span class="token punctuation">.</span>vertexShader <span class="token operator">=</span> shader<span class="token punctuation">.</span>vertexShader<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
<span class="token string">'#include &lt;begin_vertex&gt;'</span><span class="token punctuation">,</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
#include &lt;begin_vertex&gt;

float angle = (position.y + uTime) * 0.9;
mat2 rotateMatrix = get2dRotateMatrix(angle);

transformed.xz = rotateMatrix * transformed.xz;
</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>JavaScript</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p>If you look at the shadow on the plane, you should see the twist too. But still, we have a problem. The drop shadow is fine, but the core shadow on the model seems wrong and it looks like the shadow is rotating with the vertices.</p>
<p>
        </p><div class="js-video video">
            <video class="js-element element" width="1792" height="1120" controls="" src="./assets/lessons/31/step-08.mp4"></video>
            <div class="js-overlay overlay"></div>
            <div class="logo">
                <svg version="1.1" id="Calque_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 58.5 66.6" style="enable-background:new 0 0 58.5 66.6;" xml:space="preserve">
                    <path class="face-1" d="M23.1,55.7l16.1-9.3c0,0,0,0,0,0c1.1-0.7,1.8-1.9,1.8-3.1l0.1-19.1L23.1,34.4V55.7z"></path>
                    <path class="face-2" d="M21.3,10L2.9,20.5l18,10.2l18.4-10.5c0,0,0,0-0.1,0l-17.4-10C21.7,10.1,21.5,10.1,21.3,10z"></path>
                    <path class="face-3" d="M1.8,46.7L18,56.6c0,0,0,0,0,0c0.3,0.2,0.5,0.3,0.8,0.3V34.5L0,23.8v19.7C0,44.9,0.7,46.1,1.8,46.7z"></path>
                    <path class="triangle-1" d="M56.8,30.4l-11.4-6.6l-0.1,19.2l11.5-6.7c1-0.6,1.7-1.7,1.7-2.9C58.5,32.1,57.9,31,56.8,30.4z"></path>
                    <path class="triangle-2" d="M0,50.7v12.6c0,1.2,0.6,2.3,1.7,2.9c0.5,0.3,1.1,0.5,1.7,0.5c0.6,0,1.2-0.2,1.7-0.5l10.4-6L0,50.7z"></path>
                    <path class="triangle-3" d="M16.4,7L5.1,0.5c-1-0.6-2.3-0.6-3.4,0C0.6,1.1,0,2.2,0,3.4v13.2L16.4,7z"></path>
                </svg>
            </div>
        </div>
    <p></p>
<p>This is an issue related to the <strong>normals</strong>.</p>
<h2>Fixing the normals</h2>
<p>In the previous lessons, we saw that normals are coordinates associated with each vertices that tell what direction the faces are facing. If we were to see those normals, they would be arrows all over the model pointing on the outside. Those normals are used for things like lighting, reflecting and shadowing.</p>
<p>When we rotated our vertices, we merely rotated the positions, but we didn't rotate the normals. We need to modify the chunk that handles normals.</p>
<p>Hang on; this part is a little tricky.</p>
<p>The chunk handling the normals first is called <code spellcheck="false">beginnormal_vertex</code>. Let's replace it for the <code spellcheck="false">material</code> —not the <code spellcheck="false">depthMaterial</code> because this one doesn't need the normals:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-javascript"><code spellcheck="false" class=" language-javascript">material<span class="token punctuation">.</span><span class="token function-variable function">onBeforeCompile</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">shader</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
<span class="token comment">// ...</span>

shader<span class="token punctuation">.</span>vertexShader <span class="token operator">=</span> shader<span class="token punctuation">.</span>vertexShader<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
<span class="token string">'#include &lt;beginnormal_vertex&gt;'</span><span class="token punctuation">,</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
#include &lt;beginnormal_vertex&gt;
</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">)</span>

<span class="token comment">// ...</span>
<span class="token punctuation">}</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>JavaScript</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p>If you look at the chunk located in <code spellcheck="false">/node_modules/three/src/renderers/shaders/ShaderChunks/beginnormal_vertex.glsl.js</code>, you'll see that the normal variable name is <code spellcheck="false">objectNormal</code>. We could be tempted to do the same thing we did for the <code spellcheck="false">transformed</code> variable:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-glsl"><code spellcheck="false" class=" language-glsl"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;beginnormal_vertex&gt;</span></span>

<span class="token keyword">float</span> angle <span class="token operator">=</span> <span class="token punctuation">(</span>position<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">4.0</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span>uTime<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.9</span><span class="token punctuation">;</span>
<span class="token keyword">mat2</span> rotateMatrix <span class="token operator">=</span> <span class="token function">get2dRotateMatrix</span><span class="token punctuation">(</span>angle<span class="token punctuation">)</span><span class="token punctuation">;</span>

objectNormal<span class="token punctuation">.</span>xz <span class="token operator">=</span> rotateMatrix <span class="token operator">*</span> objectNormal<span class="token punctuation">.</span>xz<span class="token punctuation">;</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>GLSL</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p>Unfortunately, this will result in a shader error, containing the following messages: <code spellcheck="false">'angle' : redefinition</code> and <code spellcheck="false">'rotateMatrix' : redefinition</code>.</p>
<p>That happens because we forgot that all those shaders chunks, in the end, will be merged into a unique shader. The code we added to the <code spellcheck="false">beginnormal_vertex</code> chunk will be aside of the code added to the <code spellcheck="false">begin_vertex</code>, and we cannot have two variable declarations with the same name.</p>
<p>We need to remove the double declarations. If you look at the initial <code spellcheck="false">vertexShader</code>, you'll see that the <code spellcheck="false">beginnormal_vertex</code> happens before the <code spellcheck="false">begin_vertex</code>. This means that we should remove the <code spellcheck="false">angle</code> and <code spellcheck="false">rotateMatrix</code> from the <code spellcheck="false">begin_vertex</code>:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-javascript"><code spellcheck="false" class=" language-javascript">material<span class="token punctuation">.</span><span class="token function-variable function">onBeforeCompile</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">shader</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
<span class="token comment">// ...</span>

shader<span class="token punctuation">.</span>vertexShader <span class="token operator">=</span> shader<span class="token punctuation">.</span>vertexShader<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
<span class="token string">'#include &lt;beginnormal_vertex&gt;'</span><span class="token punctuation">,</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
#include &lt;beginnormal_vertex&gt;

float angle = (position.y + uTime) * 0.9;
mat2 rotateMatrix = get2dRotateMatrix(angle);

objectNormal.xz = rotateMatrix * objectNormal.xz;
</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">)</span>
shader<span class="token punctuation">.</span>vertexShader <span class="token operator">=</span> shader<span class="token punctuation">.</span>vertexShader<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
<span class="token string">'#include &lt;begin_vertex&gt;'</span><span class="token punctuation">,</span>
<span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
#include &lt;begin_vertex&gt;

transformed.xz = rotateMatrix * transformed.xz;
</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>JavaScript</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p>
        </p><div class="js-video video">
            <video class="js-element element" width="1792" height="1120" controls="" src="./assets/lessons/31/step-09.mp4"></video>
            <div class="js-overlay overlay"></div>
            <div class="logo">
                <svg version="1.1" id="Calque_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 58.5 66.6" style="enable-background:new 0 0 58.5 66.6;" xml:space="preserve">
                    <path class="face-1" d="M23.1,55.7l16.1-9.3c0,0,0,0,0,0c1.1-0.7,1.8-1.9,1.8-3.1l0.1-19.1L23.1,34.4V55.7z"></path>
                    <path class="face-2" d="M21.3,10L2.9,20.5l18,10.2l18.4-10.5c0,0,0,0-0.1,0l-17.4-10C21.7,10.1,21.5,10.1,21.3,10z"></path>
                    <path class="face-3" d="M1.8,46.7L18,56.6c0,0,0,0,0,0c0.3,0.2,0.5,0.3,0.8,0.3V34.5L0,23.8v19.7C0,44.9,0.7,46.1,1.8,46.7z"></path>
                    <path class="triangle-1" d="M56.8,30.4l-11.4-6.6l-0.1,19.2l11.5-6.7c1-0.6,1.7-1.7,1.7-2.9C58.5,32.1,57.9,31,56.8,30.4z"></path>
                    <path class="triangle-2" d="M0,50.7v12.6c0,1.2,0.6,2.3,1.7,2.9c0.5,0.3,1.1,0.5,1.7,0.5c0.6,0,1.2-0.2,1.7-0.5l10.4-6L0,50.7z"></path>
                    <path class="triangle-3" d="M16.4,7L5.1,0.5c-1-0.6-2.3-0.6-3.4,0C0.6,1.1,0,2.2,0,3.4v13.2L16.4,7z"></path>
                </svg>
            </div>
        </div>
    <p></p>
<p>Everything should be working fine now, and our <code spellcheck="false">begin_vertex</code> is using the <code spellcheck="false">angle</code> and <code spellcheck="false">rotateMatrix</code> from the <code spellcheck="false">beginnormal_vertex</code> chunk.</p>
<h2>Go further</h2>
<p>That concludes our lesson, but you can go even further if you want.</p>
<p>You could control the twist with the debug panel or even the mouse.</p>
<p>You could test other animations. For instance, this formula for the <code spellcheck="false">angle</code> looks even more disturbing —make sure to change both the <code spellcheck="false">material</code> and the <code spellcheck="false">depthMaterial</code>:</p>
<div class="code-toolbar"><pre contenteditable="" class=" language-glsl"><code spellcheck="false" class=" language-glsl"><span class="token keyword">float</span> angle <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">sin</span><span class="token punctuation">(</span>position<span class="token punctuation">.</span>y <span class="token operator">+</span> uTime<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">0.4</span><span class="token punctuation">;</span></code></pre><div class="toolbar"><div class="toolbar-item"><span>GLSL</span></div><div class="toolbar-item"><button>Copy</button></div></div></div>
<p>
        </p><div class="js-video video">
            <video class="js-element element" width="1792" height="1120" controls="" src="./assets/lessons/31/step-10.mp4"></video>
            <div class="js-overlay overlay"></div>
            <div class="logo">
                <svg version="1.1" id="Calque_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 58.5 66.6" style="enable-background:new 0 0 58.5 66.6;" xml:space="preserve">
                    <path class="face-1" d="M23.1,55.7l16.1-9.3c0,0,0,0,0,0c1.1-0.7,1.8-1.9,1.8-3.1l0.1-19.1L23.1,34.4V55.7z"></path>
                    <path class="face-2" d="M21.3,10L2.9,20.5l18,10.2l18.4-10.5c0,0,0,0-0.1,0l-17.4-10C21.7,10.1,21.5,10.1,21.3,10z"></path>
                    <path class="face-3" d="M1.8,46.7L18,56.6c0,0,0,0,0,0c0.3,0.2,0.5,0.3,0.8,0.3V34.5L0,23.8v19.7C0,44.9,0.7,46.1,1.8,46.7z"></path>
                    <path class="triangle-1" d="M56.8,30.4l-11.4-6.6l-0.1,19.2l11.5-6.7c1-0.6,1.7-1.7,1.7-2.9C58.5,32.1,57.9,31,56.8,30.4z"></path>
                    <path class="triangle-2" d="M0,50.7v12.6c0,1.2,0.6,2.3,1.7,2.9c0.5,0.3,1.1,0.5,1.7,0.5c0.6,0,1.2-0.2,1.7-0.5l10.4-6L0,50.7z"></path>
                    <path class="triangle-3" d="M16.4,7L5.1,0.5c-1-0.6-2.3-0.6-3.4,0C0.6,1.1,0,2.2,0,3.4v13.2L16.4,7z"></path>
                </svg>
            </div>
        </div>
    <p></p>
<p>You could also improve the way we handle the GLSL codes. Having dedicated files could be handy.</p>
</section>
</body>

</html>